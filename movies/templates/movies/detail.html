{% extends 'base.html' %}
{% load bootstrap4 %}

{% block title %}DETAIL OF {{ movie.title }}{% endblock title %}

{% block content %}
<h1 class="d-inline">{{ movie.title }} <small>({{ movie.year }})</small></h1>
{% if user.is_superuser  %}
<a href="{% url 'movies:update' movie.pk %}" class="btn btn-primary d-inline">ì˜í™” ì •ë³´ ìˆ˜ì •</a>
{% endif %}
<hr>

<div class="container">
  <div class="row">
    <div class="col-6 poster text-center mb-3">
      <img src="{{ movie.poster_path }}" class="img" alt="{{ movie.title }}">
    </div>

    <div class="col-6 jumbotron">
      <h4 class="display-4">Hello, world!</h4>
      <p class="lead">{{ movie.description }}</p>
      <hr class="my-4">
      <p>It uses utility classes for typography and spacing to space content out within the larger container.</p>
    </div>

    <div id="utube" class="mx-auto">
      <iframe src="{{ movie.youtube_url }}" id="contentFrame" name="contentFrame" marginwidth="0" marginheight="0"
        frameborder="0" width="100%" height="100%" scrolling="no"
        allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      <script>
        function init() {
          var doc = document.getElementById('utube');
          if (doc.offsetHeight == 0) {} else {
            pageheight = doc.offsetHeight
            parent.document.getElementById("contentFrame").height = pageheight + "px"
          }
        }
        window.onload = function () {
          init()
        }
      </script>
    </div>

  </div>
</div>

<hr>
<!-- ë¦¬ë·° ë³´ì´ëŠ” ê³³ -->
<div class="mx-auto">
  {% for rating in ratings %}
  <div class="list-group">
    {% if not user.is_authenticated %}
    <!-- ì¼ë°˜ ì‚¬ìš©ì -->
    <li class="list-group-item list-group-item-action">ì‘ì„±: {{ rating.user }} | {{ rating.comment }} | í‰ì :
      {{ rating.score }}</li>
    {% else %}
    <!-- ë¡œê·¸ì¸ ì‚¬ìš©ì ì¤‘ ì‘ì„±ìì¸ ê²½ìš° -->
    {% if request.user == rating.user %}
    <li class="list-group-item list-group-item-action">ì‘ì„±: {{ rating.user }} | {{ rating.comment }} | í‰ì :
      {{ rating.score }} <span class="del-btn" data-id="{{ rating.pk }}">ğŸ—‘ï¸</span></li>
    {% else %}
    <!-- ë¡œê·¸ì¸ ì‚¬ìš©ìì´ì§€ë§Œ ì‘ì„±ìê°€ ì•„ë‹Œ ê²½ìš° -->
    <li class="list-group-item list-group-item-action">ì‘ì„±: {{ rating.user }} | {{ rating.comment }} | í‰ì :
      {{ rating.score }}</li>
    {% endif %}
    {% endif %}
  </div>
  {% empty %}
  <p><b>ì…ë ¥ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</b></p>
  {% endfor %}
  <hr>
  <!-- ë¦¬ë·° ì‘ì„± ê³µê°„(form) -->
  {% if user.is_authenticated  %}
  <form action="{% url 'movies:rating_create' movie.pk %}" method="POST">
    {% csrf_token %}
    {% bootstrap_form rating_form %}
    <input class="btn btn-secondary" type="submit" value="ë¦¬ë·° ì¶”ê°€">
    <a class="btn btn-primary" href="{% url 'movies:index' %}">BACK</a>
  </form>
  <hr>
  {% else %}
  <a class="btn btn-warning" href="{% url 'accounts:login' %}">ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.</a>
  <a class="btn btn-primary" href="{% url 'movies:index' %}">BACK</a>
  <hr>
  {% endif %}
</div>
<script>
  // 1. ì˜í™”ë§ˆë‹¤ ì¢‹ì•„ìš” ë²„íŠ¼ì´ ìˆìœ¼ë‹ˆ ëª¨ë‘ ì„ íƒí•´ì•¼ í•œë‹¤.
  const deletebtn = document.querySelectorAll('.del-btn')

  // 2. forEach ë¥¼ ì‚¬ìš©í•´ì„œ ê°ê°ì˜ ì¢‹ì•„ìš” ë²„íŠ¼ì„ í´ë¦­
  deletebtn.forEach(button => {
    button.addEventListener('click', function (event) {
      console.log(event)
      // event.taget.dataset.id ì˜ value ëŠ” data-id ê°’ì´ ë“¤ì–´ ìˆë‹¤.
      const movieURL = event.path[7]['URL']
      console.log(movieURL)
      const rateId = event.target.dataset.id
      // ê°œë³„ ì˜í™”ì— ì¢‹ì•„ìš” ìš”ì²­ì„ ë³´ë‚¸ë‹¤.
      axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest'
      axios.defaults.xsrfCookieName = 'csrftoken'
      axios.defaults.xsrfHeaderName = 'X-CSRFToken'
      axios.post(`${movieURL}ratings/${rateId}/delete/`)
        .then(response => {
          // console.log(response)

          // document.querySelector(`#like-count-${movieId}`).innerText = response.data.count
          // if (response.data.liked) {
          //  event.target.style.color = 'crimson'
          // } else {
          //  event.target.style.color = 'black'
          // }
        })
        .catch(error => console.log(error))
    })
  })
</script>
{% endblock %}